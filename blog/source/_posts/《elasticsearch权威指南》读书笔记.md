---
title: 《Elasticsearch权威指南》读书笔记
date: 2019-11-13 17:25:30
categories: ["Elasticsearch", "读书笔记"]
tags: ["Elasticsearch", "读书笔记"]
---

# 《Elasticsearch权威指南》读书笔记

## 基础入门

Elasticsearch是一个实时的分布式搜索分析引擎，被用作全文检索、结构化搜索、分析以及这三个功能的组合。

### 你知道的，为了搜索

#### 和Elasticsearch交互

##### Java API

Elasticsearch内置了两个客户端

###### 节点客户端（Node client）

节点客户端是一个非数据节点加入本地集群，但它知道数据在哪个几点钟， 并把请求转发到正确的节点。

###### 传输客户端（Transport client）

将请求发送到远程集群中的节点上，本身不加入集群

两个客户端都是通过9300端口并使用Elasticsearch的原生传输协议和集群交互，集群中也通过9300端口通信

##### RESTful API with JSON over HTTP

所有语言可以通过RESTful API通过9200端口与Elasticsearch通信，模拟一个HTTP请求就可以进行交互

#### 面向文档

文档是以某种格式或者编码来封装和编码数据，课粗略的等价于对象这个概念，文档存储在一个单一存储中允许不同类型的文档，运行在文档中的字段是可选的。

#### 索引员工文档

一个Elasticsearch集群可以包含多个索引，每个索引可以包含多个类型，每个类型存储多个文档，每个文档有多个属性

>索引（名词）:相当于关系型数据库中的database  
>索引（动词）：索引一个文档是指存储一个文档到一个索引中，相当于`INSERT`  
>倒排索引：MySQL通过添加一个索引，比如B+树索引到指定的列上，以提高检索速度，Elasticsearch使用`倒排索引`来提高检索速度  
>>倒排索引是存储在全文搜索下某个单词在一个文档或者一组文档中的存储位置的映射。详情可看[倒排索引](https://zh.wikipedia.org/wiki/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95)

添加一个文档的命令很简单

```bash
curl -X PUT 'http:localhost:9200/megacorp/employee/1' -d '
{
    "first_name" : "John",
    "last_name" : "Smith",
    "age" : 25,
    "about" : "I love to go rock climbing",
    "interests" : ["sports", "music"]
}
'
```

`megacorp`是索引名称，`employee`是类型名称，`1`是id，`-d`的请求体是JSON文档内容

#### 轻量搜索

搜索可以通过`GET`请求获取文档，比如  

```bash
curl -X GET 'http://localhost:9200/megacorp/employee/1'
```

来获取`megacorp`索引下的`employee`类型的id为`1`的文档。  
如果想检索指定索引类型下的所有文档，可以使用`_search`代替`1`。如果想返回`last_name`是`Smith`的文档，则在url最后追加`?q=last_name:Smith`
>在url后面添加`?pretty`可以使返回的JSON结构化展示

#### 使用查询表达式搜索

通过命令可以方便查询，但有局限性，所以可以使用查询表达式，例如上一条查询可以修改为

```bash
curl -X GET 'http://localhost:9200/megacorp/employee/_search' -d '
{
    "query" : {
        "match" : {
            "last_name" : "Smith"
        }
    }
}
'
```

`match`的搜索会将词分开，比如`{match:{"about":"rock climbing"}}`，它会匹配`about`中包含`rock`和`climbing`，而不是会匹配`rock climbing`，要想匹配短语，则需要使用`match_phrase`关键字了

#### 分析

有了数据后可以做分析，elasticsearch有个功能叫做聚合，例子如下

```bash
curl -X GET 'http://localhost:9200/megacorp/employee/_search' -d '
{
    "aggs" : {
        "all_interests" : {
            "terms" : { "field" : "interests" }
        }
    }
}
'
```

这条语句是将数据中所有的`interests`分类，并统计数量，同时这个聚合功能可以与其他查询构成一个组合查询，比如`last_name`是`Smith`的爱好。而且还构成分级查询，比如各个爱好的平均年龄

```bash
curl -X GET 'http://localhost:9200/megacorp/employee/_search' -d '
{
    "aggs" : {
        "all_interests" : {
            "terms" : { "field" : "interests" },
            "aggs" : {
                "avg_age" : {
                    "avg" : {"field" : "age"}
                }
            }
        }
    }
}
'
```

### 集群内的原理

#### 空集群

空集群是指一个单独的节点，里面不包含任何数据和索引。一个运行的实例是一个节点，而集群是由一个或多个拥有相同的`cluster.name`配置的节点组成，共同承担数据和负载压力，当有节点加入或移除，集群会重新平均分布所有数据。  
当一个节点的配置`node.master: true`，则有资格被选举为主节点，主节点负责管理集群范围内的所有变更，而不需要涉及到文档数据的操作，流量的增加也不会成为瓶颈。  
每个节点都知道任何文档的位置，且可以将请求直接转发到处理文档的节点并收集回数据，将结果返回给客户端。  

#### 添加索引

索引是保存相关数据的地方，实际上指向一个或者多个物理分片的逻辑命名空间。  
而分片是一个底层的工作单元，保存全部数据的一部分。一个分片是一个Lucene实例，且本身就是一个完成的搜索引擎。文档被存储和索引到分片内，但应用程序是世界与索引交互而不是和分片交互。  
Elasticsearch利用分片将数据分发到集群内各处，分片是数据的容器，文档保存在分片内，分片又被分配到集群的各个节点，当集群规模扩大或者缩小，Elasticsearch会自动在各节点迁移分片，使得数据君越分布在集群内。  
分片分为主分片和副本分片，任何一个分片都归属于一个主分片。副本分片是主分片的考本，是作为硬件故障下保护数据不丢失的冗余备份，并为文档操作提供服务。  
在索引建立的时候就确定了主分片的数量，而副本分片数量可以随时修改。命令如下

```bash
curl -X PUT 'http://localhost:9200/blogs' -d '
{
    "settings" : {
        "number_of_shards" : 3,
        "number_of_replicas" : 1
    }
}
'
```

可以通过`_cluster/health`来查询集群健康，在单节点执行上面的命令后，集群健康为`yellow`，表示主分片正常运行（集群可以正常服务所有请求），但是副本分片没有全部处于正常状态。这里是因为副本分片还没有被分配到任何节点，在同一节点上即保存主分片又保存副本分片没有意义，副本分片的意义是为了保护数据不丢失。  
>green：所有的主分片和副本分片都正常运行  
>yellow：所有的主分片都正常运行，但不是所有的副本分片都正常运行  
>red：主分片没能正常运行

#### 添加故障转移

启动第二个节点就可以避免单点故障问题——没有冗余，需要配置与第一个节点相同的`cluster.name`，这样就会自动加入到集群当中。这时，第一个节点就会将副本分片分配到第二个节点了，就无须担心一个节点宕机。

#### 水平扩容

分片是一个功能完整的搜索引擎，拥有使用一个节点的所有资源的能力，如果有6个分片（3主 + 3副本）的索引可以最大扩容到6个节点，每个节点一个分片，每个分片拥有所有节点的全部资源。随着节点的增加，可以增加副本分片的数量，这样可以提高吞吐量。  
从性能上看，肯定是节点越多、副本分片数量越多越好，可实际上，要找到一个平衡点，避免资源浪费。

#### 应对故障

假设一个集群中有3个几点，我们关闭一个主节点，此时集群中必须拥有一个主节点来保证正常工作，所以发生的第一件事情就是选举一个新的主节点。  
因为关闭了一个主节点，则上面的主分片也不会存在，此时检查集群健康则状态是`red`。好在其他节点有主分片的完整副本，所以新的主节点会将这些在其他节点上的对应副本节点提升为主分片。

### 数据输入和输出

#### 文档元数据

一个文档不仅有数据，还有元数据，既有关文档的信息，有三个必须的元数据元素：`_index` `_type` `_id`。  

##### _index

文档在哪存放，即索引，是因有共同的特性被分组到一起的文档集合。实际上，Elasticsearch中数据被存储和索引在分片中，而索引是逻辑上的命名空间，由一个或者多个分片组合在一起，对于程序而言根本不关心分片，只需要知道文档位于哪个索引内。  
>索引名必须小写，不能以下划线开头，不能包含逗号

##### _type

对数据进行逻辑分区
>命名可以是大写或者小写，但不能以下划线或者句号开头，不应该包含逗号，且长度限制为256个字符

##### _id

ID是一个字符串，与`_index`和`_type`组成可以唯一确定文档。ID可有Elasticsearch自动生成

#### 取回一个文档

模板是`curl -X GET 'http://localhost:9200/{_index}/{_type}/{_id}'`，可以在后面加一些参数（`pretty`等）。传递curl的`-i`参数可以显示相应的头，传递`?_source`可以返回指定的字段，`/_source`只返回`_source`字段，不需要任何元数据。

## 疑问

- 如果连接的不是主节点，而是数据节点会发生什么。
